# 数据库



- Mysql 关系型
- MongoDB 文档型
- sqlite 轻量级关系型



## 数据库组件

- 进程管理器：管理多客户端连接
- 网络管理器：对网络协议进行管理
- 监控管理
- ...
- 查询管理
  - 解析器
  - 重写器
  - 优化器
  - 执行器
- 数据管理
  - 事务管理器
  - 缓存管理器
  - 数据访问管理器







## Mysql

### Q&A

1. Mysql有几种锁
   1. 行锁

      1. 共享锁：运行读
      2. 排他锁：运行写

   2. 表锁

      1. 意向共享锁：
      2. 意向排他锁：

   3. 记录锁 ： 单列锁：SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;

   4. 间隙锁 （范围锁）： 

      多行同时锁：SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE; 

      当有记录视图修改锁定条件中的值时，就会拒绝，比如value>20 for UPDATE之后又想添加或者删除value=25的值

      

2. 数据库引擎

   1. InnoDb
   2. MyISAM
      1. 读远超于写
      2. 无事务
      3. table级锁定粒度
   3. Memery

3. 数据库事务
   1. 隔离级别？
   2. 如何实现？

4. 数据库索引是怎么实现的？
   1. 数据结构？
      1. B+tree索引
         1. InnoDb、MyISAM、Memery
      2. Hash索引
         1. Memery，只适用于键值对
      3. Full-text索引
         1. 倒排索引
      4. 空间索引
   2. 什么是聚集索引？主键
   3. 负面影响？
      1. 维护成本
   4. 什么情况不适合建索引
      1. 重复值较多
      2. text大文本

5. Mysql 外连接、内连接、自连接、左连接

6. 权限？

7. SQL注入是怎么回事？

8. 高可用 - 集群分布式

9. 什么是视图？有什么作用？

10. 什么是游标？

11. Exists 和 in

    1. 运用索引的不同
    2. in 相当于 select * from A where A.id =1 or A.id=2.... 主要用A的索引
    3. exsists 相当于 SELECT * FROM A WHERE EXISTS (SELECT * from B WHERE B.id = A.id); 主要用B的索引

---



## 索引

- B+ Tree 索引
- 哈希索引 : 只适合键值对
- Full-text索引
- 空间索引



## 优化

- 索引，最左原则
- 减少全表查询
- 定期更行表统计信息
- 调整Mysql缓存池







## 引擎

- InnoDB，默认，事务安全，行锁定，外键索引
- MyISAM

| 特征                    | MyISAM     | Memory       | InnoDB     | Archive    | NDB        |
| :---------------------- | :--------- | :----------- | :--------- | :--------- | :--------- |
| **B树索引**             | 是的       | 是的         | 是的       | 不         | 不         |
| 备份/时间点恢复（注 1） | 是的       | 是的         | 是的       | 是的       | 是的       |
| 集群数据库支持          | 不         | 不           | 不         | 不         | 是的       |
| 聚集索引                | 不         | 不           | 是的       | 不         | 不         |
| 压缩数据                | 是（注2）  | 不           | 是的       | 是的       | 不         |
| 数据缓存                | 不         | 不适用       | 是的       | 不         | 是的       |
| 加密数据                | 是（注 3） | 是（注 3）   | 是（注 4） | 是（注 3） | 是（注 3） |
| 外键支持                | 不         | 不           | 是的       | 不         | 是（注 5） |
| **全文检索索引**        | 是的       | 不           | 是（注 6） | 不         | 不         |
| 地理空间数据类型支持    | 是的       | 不           | 是的       | 是的       | 是的       |
| 地理空间索引支持        | 是的       | 不           | 是（注 7） | 不         | 不         |
| **哈希索引**            | 不         | 是的         | 否（注 8） | 不         | 是的       |
| 索引缓存                | 是的       | 不适用       | 是的       | 不         | 是的       |
| 锁定粒度                | 桌子       | 桌子         | 排         | 排         | 排         |
| MVCC                    | 不         | 不           | 是的       | 不         | 不         |
| 复制支持（注 1）        | 是的       | 有限（注 9） | 是的       | 是的       | 是的       |
| 存储限制                | 256TB      | 内存         | 64TB       | 没有       | 384EB      |
| T-树索引                | 不         | 不           | 不         | 不         | 是的       |
| 交易                    | 不         | 不           | 是的       | 不         | 是的       |
| 更新数据字典的统计信息  | 是的       | 是的         | 是的       | 是的       | 是的       |

---

## B+树

![432222c9e8cd2d665083915430ae1a2e.png](http://tva1.sinaimg.cn/large/006fuBezly1gzs5zgr0n1j30n00bvn18.jpg)

引入问题：如何在一颗二叉查找树中找到区间的值[x,y]？（二叉搜索树）

回答：查x的位置O(log n) ，查y的位置O(log_n)，但把这区间的值全部找到却需要进枚举遍历，或者对二叉树进行中序查找，这种O(n)的



B+树就是为了解决查找树的区间搜索问题

**特征**

- 每个节点有多个子节点而不是2

- 只有叶子节点才保存信息

- 叶子节点是链表

- 其它节点只是在**搜索中**用来**指引**到正确节点的。

  ![15c4b064af9ac7f357404a1b17ff1cae.png](http://tva1.sinaimg.cn/large/006fuBezly1gzs5wrbheyj312q0g17dp.jpg)

---------







## SQLite 轻量级数据库

- 和程序绑定，单服务器(而不该处理集群)
- 实现了SQL标准：事务，支持复杂查询
- 单线程写入

---

## 事务隔离级别

事务的执行：

1. 开始
2. 执行
3. 提交



解决的问题：

- 脏读：事务失败回滚造成的，读到的数据实际上不存在，非常危险，违法一致性，数据不可靠
- 可重复读(我们需要的情形)：同一事务中的“一致性读取”读取第一次读取建立的快照
- 不可重复读：同一事务中的一致性读取读到的数据可能不一致
- 幻读：
  - 表中数字1 ，A查出来是1(不关事务)，B修改把1修改为2，这时A是看不到的，会
    - 但业务上是逻辑有效的



读第一次快照or读当前？

读已经提交的or读还没提交的? （读第一次快照肯定不会读到其它事务的更新修改）

一致性读取 ：本事务更新该条信息时，会更新快照

| 隔离级别                                                     | 脏读   | 不可重复读 | 幻读                        |
| ------------------------------------------------------------ | ------ | ---------- | --------------------------- |
| 读未提交: （读当前数据，并且可以读另一个事务未提交的数据）   | 可能   | 可能       | 可能                        |
| 读提交 : 同一事务中的一致性读取,都会重新设置并读取自己的新快照，**gap锁定已禁用**，因此可能会出现幻像行问题 | 不可能 | 可能       | 可能                        |
| 可重复读（默认） ：同一事务中的一致性读取读取第一次读取建立的快照（自己更新数据时，会更新受影响的查询快照） | 不可能 | 不可能     | 可能<br />通过gap锁可以解决 |
| 串行化                                                       | 不可能 | 不可能     | 不可能                      |

---

## 



